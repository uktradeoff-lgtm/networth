<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>True Earnings Calculator (UK)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 860px; margin: 28px auto; padding: 0 14px; line-height: 1.35; }
    h1 { font-size: 22px; margin: 0 0 8px; }
    .sub { color:#666; font-size: 13px; margin-bottom: 14px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin: 12px 0; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    label { display: block; font-weight: 650; margin-bottom: 6px; }
    input[type="number"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 10px; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; font-weight: 800; }
    .hint { color: #555; font-size: 13px; margin-top: 6px; }
    .kpis { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
    .kpi { background:#fafafa; border:1px solid #eee; border-radius:12px; padding: 12px; }
    .kpi .name { color:#666; font-size: 12px; }
    .kpi .val { font-size: 18px; font-weight: 850; margin-top: 4px; }
    .warn { background: #fff6e5; border: 1px solid #ffd08a; padding: 10px; border-radius: 10px; margin-top: 10px; }
    .err { background: #ffecec; border: 1px solid #ffb3b3; padding: 10px; border-radius: 10px; margin-top: 10px; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
    th, td { border-bottom:1px solid #eee; padding: 8px; text-align:left; vertical-align: top; }
    th { background:#fafafa; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
  </style>
</head>
<body>
  <h1>True Earnings Calculator (UK)</h1>
  <div class="sub">
    England/Wales/NI income tax. Ignores carry forward and does not include National Insurance.
    Educational only, not financial advice.
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px; font-size:16px;">Inputs</h2>
    <div class="grid">
      <div>
        <label for="grossIncome">Gross income (£/year)</label>
        <input id="grossIncome" type="number" min="0" step="100" placeholder="e.g. 160000" />
        <div class="hint">Use annual gross income (employment or total taxable income you want to model).</div>
      </div>
      <div>
        <label for="pension">Pension contribution this tax year (£)</label>
        <input id="pension" type="number" min="0" step="100" placeholder="e.g. 60000" />
        <div class="hint">
          Assumes contributions reduce taxable income (salary sacrifice / net pay). Relief-at-source works differently.
        </div>
      </div>
    </div>

    <div style="height:10px;"></div>

    <div class="grid">
      <div>
        <label for="otherDeductions">Other deductions reducing taxable income (optional) (£)</label>
        <input id="otherDeductions" type="number" min="0" step="100" placeholder="0" />
        <div class="hint">Optional. Leave blank if not relevant.</div>
      </div>
      <div>
        <label for="employerPension">Employer pension contribution (optional) (£)</label>
        <input id="employerPension" type="number" min="0" step="100" placeholder="0" />
        <div class="hint">
          Used only for tapered annual allowance check (adjusted income approximation) and for total wealth calculation display.
        </div>
      </div>
    </div>

    <div style="height:12px;"></div>
    <button id="calcBtn" type="button">Calculate</button>

    <div id="errorBox" class="err" style="display:none;"></div>
    <div id="warnings" class="warn" style="display:none;"></div>

    <div id="results" style="display:none;">
      <div class="kpis">
        <div class="kpi">
          <div class="name">Taxable income (after deductions)</div>
          <div class="val" id="kpiTaxable">£0</div>
        </div>
        <div class="kpi">
          <div class="name">Income tax</div>
          <div class="val" id="kpiTax">£0</div>
        </div>
        <div class="kpi">
          <div class="name">Take-home after income tax (no NI)</div>
          <div class="val" id="kpiTakeHome">£0</div>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="name">Pension added (employee + employer)</div>
          <div class="val" id="kpiPension">£0</div>
        </div>
        <div class="kpi">
          <div class="name">Total wealth generated (with pension)</div>
          <div class="val" id="kpiWealth">£0</div>
        </div>
        <div class="kpi">
          <div class="name">Personal allowance used</div>
          <div class="val" id="kpiPA">£0</div>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="name">Take-home if pension = £0 (no NI)</div>
          <div class="val" id="kpiTakeHomeNoPension">£0</div>
        </div>
        <div class="kpi">
          <div class="name">Wealth if pension = £0</div>
          <div class="val" id="kpiWealthNoPension">£0</div>
        </div>
        <div class="kpi">
          <div class="name">Wealth uplift from pension</div>
          <div class="val" id="kpiWealthDelta">£0</div>
        </div>
      </div>

      <div id="breakdownWrap" style="display:none;">
        <h3 style="margin:14px 0 6px; font-size:14px;">Income tax breakdown</h3>
        <table>
          <thead>
            <tr>
              <th>Band</th>
              <th>Taxed amount</th>
              <th>Rate</th>
              <th>Tax</th>
            </tr>
          </thead>
          <tbody id="breakdownBody"></tbody>
        </table>
        <div class="sub" style="margin-top:10px;">
          Personal Allowance is £12,570, reduced by £1 for every £2 of income above £100,000, and becomes £0 at £125,140.
          Annual allowance tapering is approximated (see notes).
        </div>
      </div>
    </div>
  </div>

  <script>
    // 2025/26 England/Wales/NI income tax (non-savings, non-dividend) bands.
    const RULES_2025_26 = {
      personalAllowance: 12570,
      paTaperStart: 100000,
      paZeroAt: 125140,
      // Bands expressed on "taxable income after allowances".
      bandsAfterAllowances: [
        { name: "Basic rate",    from: 0,     to: 37700,  rate: 0.20 },
        { name: "Higher rate",   from: 37700, to: 125140, rate: 0.40 },
        { name: "Additional",    from: 125140, to: Infinity, rate: 0.45 }
      ],
      // Pension annual allowance (standard) and taper rules (2025/26 assumption).
      pension: {
        standardAnnualAllowance: 60000,
        taperThreshold: 200000,        // "threshold income" reference (approx)
        adjustedIncomeLimit: 260000,   // if adjusted income exceeds this, taper applies
        minAnnualAllowance: 10000      // minimum tapered annual allowance
      }
    };

    function gbp(n) {
      const x = Math.round(n);
      return "£" + x.toLocaleString("en-GB");
    }
    function clamp(n) {
      return Number.isFinite(n) ? Math.max(0, n) : 0;
    }
    function parseMoney(id) {
      const v = document.getElementById(id).value;
      if (v === "" || v === null || v === undefined) return 0;
      return clamp(Number(v));
    }

    // Personal allowance taper for 2025/26.
    function calcPersonalAllowance(grossIncome, rules) {
      const pa = rules.personalAllowance;
      if (grossIncome <= rules.paTaperStart) return pa;
      if (grossIncome >= rules.paZeroAt) return 0;
      const reduction = (grossIncome - rules.paTaperStart) / 2; // £1 for every £2
      return Math.max(0, pa - reduction);
    }

    // Apply banded income tax to "taxable income after allowances".
    function calcIncomeTax(taxableAfterAllowances, rules) {
      let remaining = clamp(taxableAfterAllowances);
      let tax = 0;
      const breakdown = [];

      for (const band of rules.bandsAfterAllowances) {
        if (remaining <= 0) break;

        const bandWidth = (band.to === Infinity) ? Infinity : (band.to - band.from);
        const taxedAmount = Math.min(remaining, bandWidth);

        const bandTax = taxedAmount * band.rate;
        tax += bandTax;

        breakdown.push({
          band: band.name,
          amount: taxedAmount,
          rate: band.rate,
          tax: bandTax
        });

        remaining -= taxedAmount;
      }
      return { tax, breakdown };
    }

    // Tapered annual allowance (approximation).
    // Actual HMRC definitions use "threshold income" and "adjusted income".
    // Here we approximate:
    // - thresholdIncome ≈ grossIncome - employeePension (salary sacrifice reduces)
    // - adjustedIncome ≈ grossIncome + employerPension (broadly adds employer contrib)
    function calcAnnualAllowanceApprox(grossIncome, employeePension, employerPension, rules) {
      const p = rules.pension;
      let allowance = p.standardAnnualAllowance;

      const thresholdIncome = Math.max(0, grossIncome - employeePension);
      const adjustedIncome = Math.max(0, grossIncome + employerPension);

      // Taper applies only if BOTH conditions met in typical HMRC framing:
      // threshold income > £200k and adjusted income > £260k.
      if (thresholdIncome > p.taperThreshold && adjustedIncome > p.adjustedIncomeLimit) {
        const excess = adjustedIncome - p.adjustedIncomeLimit;
        const reduction = Math.floor(excess / 2); // £1 reduction per £2 excess
        allowance = Math.max(p.minAnnualAllowance, p.standardAnnualAllowance - reduction);
      }
      return { allowance, thresholdIncome, adjustedIncome };
    }

    function showError(msg) {
      const e = document.getElementById("errorBox");
      e.style.display = "block";
      e.innerHTML = "<strong>Error:</strong> " + msg;
      document.getElementById("warnings").style.display = "none";
      document.getElementById("warnings").innerHTML = "";
      document.getElementById("results").style.display = "none";
    }

    function clearError() {
      const e = document.getElementById("errorBox");
      e.style.display = "none";
      e.innerHTML = "";
    }

    function calculate() {
      const rules = RULES_2025_26;

      const grossIncome = parseMoney("grossIncome");
      const pension = parseMoney("pension"); // employee pension
      const employerPension = parseMoney("employerPension");
      const otherDeductions = parseMoney("otherDeductions");

      clearError();

      if (grossIncome <= 0) {
        showError("Enter a gross income above £0.");
        return;
      }

      // if pension > 60k, do not calculate.
      if (pension > rules.pension.standardAnnualAllowance) {
        showError(`Pension contribution exceeds £60,000. This calculator ignores carry forward. Reduce pension to £60,000 or less to calculate.`);
        return;
      }

      const warnings = [];

      // Tapered allowance approximation and check (only for warning + eligibility).
      const taper = calcAnnualAllowanceApprox(grossIncome, pension, employerPension, rules);
      if (taper.allowance < rules.pension.standardAnnualAllowance) {
        warnings.push(
          `Annual allowance may be tapered based on your income. Approx allowance: ${gbp(taper.allowance)} (threshold income ≈ ${gbp(taper.thresholdIncome)}, adjusted income ≈ ${gbp(taper.adjustedIncome)}).`
        );
        // If taper makes allowance lower than employee pension, block calculation
        if (pension > taper.allowance) {
          showError(`Your entered pension (${gbp(pension)}) exceeds the estimated tapered annual allowance (${gbp(taper.allowance)}). Adjust inputs or seek advice. This tool will not calculate in this case.`);
          return;
        }
      }

      // Taxable income before personal allowance: gross minus deductions that reduce taxable income.
      // (We treat employee pension and other deductions as reducing taxable income.)
      const taxableBeforePA = Math.max(0, grossIncome - pension - otherDeductions);

      const personalAllowance = calcPersonalAllowance(grossIncome, rules);
      const taxableAfterPA = Math.max(0, taxableBeforePA - personalAllowance);

      const { tax, breakdown } = calcIncomeTax(taxableAfterPA, rules);

      // Take-home after income tax (no NI). Take-home is what's left after tax and employee deductions.
      const takeHome = grossIncome - tax - pension - otherDeductions;

      // Total pension added (employee + employer) shown (employer doesn't reduce employee take-home here).
      const totalPensionAdded = pension + employerPension;

      // Wealth generated with pension = take-home + total pension added.
      const wealthGenerated = takeHome + totalPensionAdded;

      // Scenario: no pension contribution (employee pension = 0) to show comparison.
      const taxableBeforePA_NoPension = Math.max(0, grossIncome - 0 - otherDeductions);
      const personalAllowance_NoPension = calcPersonalAllowance(grossIncome, rules);
      const taxableAfterPA_NoPension = Math.max(0, taxableBeforePA_NoPension - personalAllowance_NoPension);
      const tax_NoPension = calcIncomeTax(taxableAfterPA_NoPension, rules).tax;
      const takeHome_NoPension = grossIncome - tax_NoPension - 0 - otherDeductions;

      // Wealth with no pension: take-home + employer pension (employer contrib may still exist)
      const wealth_NoPension = takeHome_NoPension + employerPension;

      const delta = wealthGenerated - wealth_NoPension;

      // Render warnings
      const warnEl = document.getElementById("warnings");
      if (warnings.length) {
        warnEl.style.display = "block";
        warnEl.innerHTML = "<strong>Notes:</strong><ul style='margin:8px 0 0 18px;'>" +
          warnings.map(w => `<li>${w}</li>`).join("") +
          "</ul>";
      } else {
        warnEl.style.display = "none";
        warnEl.innerHTML = "";
      }

      // KPIs
      document.getElementById("kpiTaxable").textContent = gbp(taxableAfterPA);
      document.getElementById("kpiTax").textContent = gbp(tax);
      document.getElementById("kpiTakeHome").textContent = gbp(takeHome);
      document.getElementById("kpiPension").textContent = gbp(totalPensionAdded);
      document.getElementById("kpiWealth").textContent = gbp(wealthGenerated);
      document.getElementById("kpiPA").textContent = gbp(personalAllowance);

      document.getElementById("kpiTakeHomeNoPension").textContent = gbp(takeHome_NoPension);
      document.getElementById("kpiWealthNoPension").textContent = gbp(wealth_NoPension);
      document.getElementById("kpiWealthDelta").textContent = (delta >= 0 ? "+" : "") + gbp(delta);

      // Breakdown table
      const tbody = document.getElementById("breakdownBody");
      tbody.innerHTML = "";
      breakdown.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.band}</td>
          <td>${gbp(row.amount)}</td>
          <td>${Math.round(row.rate * 100)}%</td>
          <td>${gbp(row.tax)}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("breakdownWrap").style.display = "block";
      document.getElementById("results").style.display = "block";
    }

    document.getElementById("calcBtn").addEventListener("click", calculate);

    // Automatic calculations
    ["grossIncome", "pension", "otherDeductions", "employerPension"].forEach(id => {
      document.getElementById(id).addEventListener("input", () => {
        if (parseMoney("grossIncome") > 0) calculate();
      });
    });
  </script>
</body>
</html>
